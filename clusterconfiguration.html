<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>

  <title>Perl Ocean</title>

  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="google-code-prettify/prettify.css" rel="stylesheet">
</head>

<body>

  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
        <a class="brand" href="#">Perl Ocean</a>
        <div class="nav-collapse">
          <ul class="nav">
            <li>
              <a href="index.html">Home</a>
            </li>
            <li>
              <a href="installation.html">Getting Started</a>
            </li>
            <li>
              <a href="protocol.html">Protocol</a>
            </li>
            <li>
              <a href="development.html">Development</a>
            </li>
            <li class="active">
              <a href="#">Cluster</a>
            </li>
            <li>
              <a href="media.html">Media Support</a>
            </li>
            <li>
              <a href="client.html">Client Libraries</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="subnav">
      <ul class="nav nav-tabs">
        <li><a href="cluster.html">概要</a></li>
        <li><a href="#">チュートリアル</a></li>
        <li><a href="#">データベース</a></li>
        <li><a href="#">実装</a></li>
        <li class="active"><a href="#">コンフィギュレーション</a></li>
        <li><a href="runcluster.html">サービスの開始</a></li>
      </ul>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row-fluid">
      <div class="span3">
        <div class="well sidebar-nav">
          <ul class="nav nav-list">
            <li class="nav-header">目次</li>
            <li><a href="#node">フロントエンドノードの設定</a></li>
            <li><a href="#config">フロントエンドノードのコンフィグ設定</a></li>
            <li><a href="#routing">フロントエンドノードのルーティング設定</a></li>
            <li><a href="#delivery">デリバリーサービスの設定</a></li>
          </ul>
        </div><!--/.well -->
      </div><!--/span-->

      <div class="span9">

        <div class="row-fluid">
          <div class="span12">
            <h2 id="node">フロントエンドノードの設定</h2>
            <p>クラスターで利用する場合、<b>コンフィグファイル</b>だけでなく<b>ルーティングスクリプト</b>も用意しなければなりません。</p>
          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">
            <h2 id="config">フロントエンドノードのコンフィグ設定</h2>
            <p>概要で説明したように、フロントエンドノードとは、ただのOcean XMPPサーバーで、クラスター用の動作が既に記述されたイベントハンドラを利用してるだけに過ぎません。ですので、基本的なコンフィグ設定は<a href="configuration.html">開発ガイド - コンフィギュレーション</a>で説明したものと同じです。</p>

            <p>クラスターのために意識しなければいけないのは、<a href="#custom">カスタムセクション</a>のみです。</p>

          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">
            <h3 id="custom">カスタムセクション</h3>
            <pre class="prettyprint lang-yaml">handler:
  node_id: node01
  serializer: json
  router: __path_to(config/router.pl)__
  fetcher:
    class: Ocean::Cluster::Frontend::Fetcher::Gearman
    config:
      inbox_host: 10.192.209.42
      inbox_port: 7002
  dispatcher:
    class: Ocean::Cluster::Frontend::Dispatcher::Gearman
    config:</pre>

            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th class="blue header">設定項目</th>
                  <th class="blue header">概要</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>node_id</td><td>ノードのIDです。適当な文字列で名前を付けて下さい。複数のフロントエンドノードの中でユニークになるように気をつけて下さい。この名前は、<a href="#worker">デリバリーサービス側の設定</a>で利用します。</td></tr>
                <tr><td>serializer</td><td>シリアライザのタイプを選択します。デフォルトは<b>json</b>です。</td></tr>
                <tr><td>router</td><td>ルーティングスクリプトのファイルパスです。ルーティングスクリプトについては下で説明します。</td></tr>
                <tr><td>fetcher</td><td>fetcherクラスとその設定パラメータを用意します。<b>Inboxキュー</b>からメッセージを受け取るためのクラスです。現在は<b>Ocean::Cluster::Frontend::Fetcher::Gearman</b>しか用意されていません。</td></tr>
                <tr><td>dispatcher</td><td>dispatcherクラスとその設定パラメータを用意します。<b>Background Dispatcher</b>にメッセージを渡すためのクラスです。現在は<b>Ocean::Cluster::Frontend::Dispatcher::Gearman</b>しか用意されていません。</td></tr>
              </tbody>
            </table>

          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">

            <h2 id="routing">フロントエンドノードのルーティング設定</h2>

            <p>複数のブローカをBackground Dispatcherとして利用する場合、イベント毎のルーティングを設定する事が可能です。</p>

            <p>上のカスタムセクションの設定における<b>router</b>項目で指定してあるファイルを開いて編集します。デフォルトではconfigディレクトリの下の<b>router.pl</b>になっています。</p>

            <pre>vi ./config/router.pl</pre>

            <pre>router {

    register_broker(mybroker00 =&gt; ["10.192.209.42:7001"]);
    # register_broker(mybroker01 =&gt; ["192.168.0.2:7001", "192.168.0.3:7001"]);

    default_route({
        broker =&gt; 'mybroker00', 
        queue  =&gt; 'ocean_default',
    });

    # event_route("message" =&gt; {
    #     broker =&gt; 'mybroker01', 
    #     queue  =&gt; 'ocean01',
    # });

    # event_route(["message", "presence"] =&gt; {
    #     broker =&gt; 'mybroker02', 
    #     queue  =&gt; 'ocean02',
    # });

};</pre>

            <p>手順としては<b>register_broker</b>で、まず必要なだけ、ブローカーの登録を行います。適当に名前をつけ、アドレスを指定します。</p>

            <p>次にイベント毎に、<b>event_route</b>で、ルーティング先の<b>ブローカー</b>と<b>キュー</b>の名前を登録していきます。</p>

            <p><b>default_route</b>でデフォルトのルーティング先を指定できます。あるイベントが発生したとき、そのイベントのルーティング先が登録されていなかった場合、デフォルトルートで指定された宛先にパケットが渡されます。</p>

            <p>イベントには次の種類があります。</p>

            <ul>
              <li>node_init</li>
              <li>node_exit</li>
              <li>node_timer_report</li>
              <li>too_many_auth</li>
              <li>sasl_auth</li>
              <li>sasl_password</li>
              <li>sasl_password</li>
              <li>sasl_success_notification</li>
              <li>http_auth</li>
              <li>bind</li>
              <li>message</li>
              <li>presence</li>
              <li>initial_presence</li>
              <li>unavailable_presence</li>
              <li>silent_disconnection</li>
              <li>roster</li>
              <li>vcard</li>
              <li>iq_toward_user</li>
            </ul>

          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">
            <h2 id="delivery">デリバリーサービスの設定</h2>
            <p>設定ファイルはプロジェクトルートの中の<b>configディレクトリ</b>の中にあります。</p>
            <pre>vi ./config/ocean-cluster.yml</pre>

            <p></p>
          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">
            <h3 id="worker">ワーカーセクション</h3>
            <pre class="prettyprint lang-yaml">worker:
  domain: xmpp.example.org
  max_workers: 1
  node_inboxes:
    - node_id: node01
      address: 10.192.209.42:7002
    - node_id: node02
      address: 10.192.209.42:7003
  broker_servers: 
    - 10.192.209.42:7001
  context_class: MyService::Context
  queue_name: ocean_default</pre>

            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th class="blue header">設定項目</th>
                  <th class="blue header">概要</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>domain</td><td>サービスドメインです。JIDのドメインパートに使われるものを指定しておきます。</td></tr>
                <tr><td>max_workers</td><td>起動するワーカーのプロセス数を指定します。</td></tr>
                <tr><td>node_inboxes</td><td>フロンとエンドノードのための<b>Inbox</b>となるブローカーのリストを指定します。それぞれノードIDとアドレスを指定しておきます。ノードIDについては、フロントエンドノードの<a href="#custom">カスタムセクション</a>で指定したものが使われるように注意して下さい。</td></tr>
                <tr><td>broker_servers</td><td><b>Background Dispatcher</b>となるブローカーのサーバーリストです。</td></tr>
                <tr><td>context_class</td><td>プロジェクトテンプレートジェネレータ実行時に回答したコンテキストクラスの名前が自動的に指定されています。基本的には自分でこの項目を編集する必要はありません。</td></tr>
                <tr><td>queue_name</td><td>キューの名前です。フロントエンドノードの<a href="#routing">ルーティング設定</a>で指定した名前と同じにして下さい。</td></tr>
              </tbody>
            </table>
          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">
            <h3 id="log">ログセクション</h3>
            <p><a href="configuration.html#log">開発ガイド - コンフィギュレーション [ ログセクション ]</a>を参照して下さい。全く同じです。</p>
          </div><!--/span-->
        </div><!--/row-->

        <div class="row-fluid">
          <div class="span12">
            <h3 id="eventhandler">イベントハンドラセクション</h3>
            <p>イベントハンドラセクションの設定例です。プロジェクトテンプレートジェネレータ実行時に、回答した名前空間をベースにして自動生成されています。この設定項目は基本的には自分で編集する必要はありません。</p>

            <p>イベントカテゴリやハンドラクラスについて詳しくは前章の<a href="integration.html">イベント</a>を参照してください。</p>

            <pre class="prettyprint lang-yaml">event_handler:
  node:       Hoge::Handler::Node
  authen:     Hoge::Handler::Authen
  connection: Hoge::Handler::Connection
  message:    Hoge::Handler::Message
  people:     Hoge::Handler::People
  room:       Hoge::Handler::Room
  p2p:        Hoge::Handler::P2P</pre>

            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th class="blue header">設定項目</th>
                  <th class="blue header">概要</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>node</td><td>Nodeイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>authen</td><td>Authenイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>connection</td><td>Connectionイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>people</td><td>Peopleイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>message</td><td>Messageイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>room</td><td>Roomイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>p2p</td><td>P2Pイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>pubsub</td><td>PubSubイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
                <tr><td>worker</td><td>Workerイベントカテゴリ用ハンドラクラスを指定します。</td></tr>
              </tbody>
            </table>
          </div>
        </div>


        <div class="row-fluid">
          <div class="span12">
            <h3 id="workercustom">カスタムセクション</h3>

            <p>ハンドラ内から利用したい項目をここで独自に定義しておくとよいでしょう。</p>

            <pre>handler:
</pre>

          </div>
        </div>


      </div><!--/span-->
    </div><!--/row-->

    <hr />
    <footer>
      <p>&copy; Lyo Kato 2012</p>
    </footer>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="google-code-prettify/prettify.js"></script>
  <script type="text/javascript">
    $(function(){
      prettyPrint();
    });
  </script>
</body>
</html>
